sources:
  fluentbit:
    type: socket
    address: 0.0.0.0:24224
    mode: tcp

transforms:
  basic_processing:
    type: remap
    inputs:
      - fluentbit
    source: |
      .tag = .tag || "unknown"
      .hostname = .host || "unknown"
      # Handle to_string fallible operation
      raw_json, err = to_string(.message)
      .raw_json = if err == null { raw_json } else { "" }
      # Try to extract timestamp from JSON, fallback to now()
      parsed, err = parse_json(.raw_json)
      .timestamp = if err == null && parsed.timestamp != null {
        parse_timestamp!(parsed.timestamp, "%Y-%m-%dT%H:%M:%S.%fZ") || now()
      } else {
        now()
      }

sinks:
  clickhouse:
    type: clickhouse
    inputs:
      - basic_processing
    endpoint: http://89.116.38.238:8123
    database: default
    table: logs
    compression: gzip
    skip_unknown_fields: true
    date_time_best_effort: true
    buffer:
      type: memory
      max_events: 1000
      when_full: block
    encoding:
      only_fields:
        - timestamp
        - tag
        - hostname
        - raw_json
  console:
    type: console
    inputs:
      - basic_processing
    target: stdout
    encoding:
      codec: json